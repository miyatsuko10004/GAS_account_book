<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>ãƒã‚±ãƒƒãƒˆå‹å®¶è¨ˆç°¿</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --primary-color: #4f46e5;
      --secondary-color: #10b981;
      --danger-color: #ef4444;
    }
    body {
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
    }
    .dark .bg-white { background-color: #1f2937; }
    .dark .bg-gray-50 { background-color: #374151; }
    .dark .border-gray-200 { border-color: #374151; }
    .dark .hover\:bg-gray-100:hover { background-color: #374151; }
    .dark .bg-green-100 { background-color: rgba(16, 185, 129, 0.1); }
    .dark .border-green-400 { border-color: rgba(52, 211, 153, 0.4); }
    .dark .text-gray-900 { color: #f9fafb; }
    .dark .text-gray-800 { color: #f3f4f6; }
    .dark .text-gray-700 { color: #d1d5db; }
    .dark .text-gray-500 { color: #9ca3af; }
    .dark .text-green-800 { color: #6ee7b7; }
    .dark .text-blue-600 { color: #60a5fa; }

    #loader {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.7); display: flex;
      justify-content: center; align-items: center; z-index: 9999;
    }
    .dark #loader { background: rgba(0, 0, 0, 0.7); }
    .spinner {
      border: 8px solid #f3f3f3; border-top: 8px solid var(--primary-color);
      border-radius: 50%; width: 60px; height: 60px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #loader.hidden { display: none; }
    
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100" onload="startApplication()">
  <div id="loader"><div class="spinner"></div></div>

  <div class="min-h-screen flex flex-col">
    <header class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-40">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <div class="flex items-center">
            <i class="fas fa-inbox text-2xl text-indigo-600 dark:text-indigo-400"></i>
            <h1 class="text-xl font-bold ml-3">ãƒã‚±ãƒƒãƒˆå‹å®¶è¨ˆç°¿</h1>
          </div>
          <div class="flex items-center gap-4">
            <button id="register-salary-btn" class="px-3 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-md shadow-sm"><i class="fas fa-money-bill-wave mr-2"></i>çµ¦æ–™ã‚’ç™»éŒ²</button>
            <button id="theme-toggle" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700">
              <i class="fas fa-sun" id="theme-icon-light"></i>
              <i class="fas fa-moon hidden" id="theme-icon-dark"></i>
            </button>
          </div>
        </div>
      </div>
    </header>

    <main class="flex-grow">
      <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div id="reminder-banner" class="hidden mb-4 p-4 bg-yellow-100 dark:bg-yellow-900 border border-yellow-400 rounded-lg text-yellow-800 dark:text-yellow-200"></div>
        <div class="border-b border-gray-200 dark:border-gray-700 mb-6 overflow-x-auto no-scrollbar">
          <nav class="-mb-px flex space-x-8 px-4 sm:px-0" aria-label="Tabs">
            <a href="#" id="tab-dashboard" class="tab border-indigo-500 text-indigo-600 dark:text-indigo-400 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
            <a href="#" id="tab-allocation" class="tab border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">äºˆç®—ã®æŒ¯åˆ†</a>
            <a href="#" id="tab-transaction" class="tab border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">å–å¼•è¨˜éŒ²</a>
            <a href="#" id="tab-history" class="tab border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">å–å¼•å±¥æ­´</a>
            <a href="#" id="tab-accounts" class="tab border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">å£åº§è¨­å®š</a>
            <a href="#" id="tab-future" class="tab border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">å°†æ¥ã®å‡ºè²»</a>
            <a href="#" id="tab-simulation" class="tab border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</a>
          </nav>
        </div>

        <div id="content-dashboard" class="content-area"></div>
        <div id="content-allocation" class="content-area hidden"></div>
        <div id="content-transaction" class="content-area hidden"></div>
        <div id="content-history" class="content-area hidden"></div>
        <div id="content-accounts" class="content-area hidden"></div>
        <div id="content-future" class="content-area hidden"></div>
        <div id="content-simulation" class="content-area hidden"></div>
      </div>
    </main>

    <footer class="bg-white dark:bg-gray-800 mt-8">
      <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 text-center text-sm text-gray-500">
        &copy; 2025 ãƒã‚±ãƒƒãƒˆå‹å®¶è¨ˆç°¿ã‚¢ãƒ—ãƒª.
      </div>
    </footer>
    
    <div id="modal-container"></div>
  </div>

  <script>
    // =================================================================
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    // =================================================================
    let simulationChart = null;
    let allData = {};

    // =================================================================
    // åˆæœŸåŒ–å‡¦ç†
    // =================================================================
    function startApplication() {
      showLoader();
      google.script.run
        .withSuccessHandler(initializeApp)
        .withFailureHandler(onFailure)
        .getInitialData();
      setupEventListeners();
    }

    function initializeApp(data) {
      allData = data;
      try {
        renderDashboard(data.dashboardData);
        renderAllocation(data.dashboardData, data.templates);
        renderTransactionForm(data.dashboardData.accounts);
        renderHistory(data.transactions);
        renderAccountSettings(data.dashboardData.accounts);
        renderFutureExpenseForm(data.futureExpenses, data.dashboardData.accounts);
        renderSimulation(data.templates, data.dashboardData.accounts);
        checkReminders();
      } catch (error) {
        console.error("A critical error occurred during initialization:", error);
        showModal('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼', 'ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è¡¨ç¤ºä¸­ã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
      } finally {
        hideLoader();
      }
    }

    // =================================================================
    // UIãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–¢æ•°
    // =================================================================
    function renderDashboard(data) {
      const container = document.getElementById('content-dashboard');
      const savingsAccounts = data.accounts.filter(acc => acc.type === 'è²¯é‡‘ãƒ»ç©ç«‹');
      const totalBalance = savingsAccounts.reduce((sum, acc) => sum + acc.balance, 0);
      
      const groupedAccounts = savingsAccounts.reduce((groups, acc) => {
        const groupName = acc.group || 'ãã®ä»–';
        if (!groups[groupName]) {
          groups[groupName] = { accounts: [], total: 0 };
        }
        groups[groupName].accounts.push(acc);
        groups[groupName].total += acc.balance;
        return groups;
      }, {});

      container.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
            <h3 class="text-lg font-medium text-gray-500 dark:text-gray-400">ç·è²¯é‡‘é¡ (è²¯é‡‘ãƒ»ç©ç«‹å£åº§åˆè¨ˆ)</h3>
            <p class="mt-1 text-3xl font-semibold text-blue-600 dark:text-blue-400">${totalBalance.toLocaleString()}å††</p>
          </div>
          <div class="bg-green-100 dark:bg-green-900 border border-green-400 p-6 rounded-lg shadow">
            <h3 class="text-lg font-medium text-green-800 dark:text-green-200">æŒ¯åˆ†å¯èƒ½ãªãŠé‡‘ (ç”Ÿæ´»è²»)</h3>
            <p class="mt-1 text-3xl font-semibold text-green-600 dark:text-green-400">${data.toBeBudgeted.toLocaleString()}å††</p>
          </div>
        </div>
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
          <h3 class="text-xl font-semibold mb-4">è²¯é‡‘ãƒ»ç©ç«‹å£åº§ã®æ®‹é«˜ä¸€è¦§</h3>
          <div class="space-y-6">
            ${Object.entries(groupedAccounts).map(([groupName, groupData]) => `
              <div>
                <h4 class="text-lg font-semibold mb-2">${groupName} <span class="text-base font-normal text-gray-500">- åˆè¨ˆ: ${groupData.total.toLocaleString()}å††</span></h4>
                <div class="space-y-4 pl-4 border-l-2 border-gray-200 dark:border-gray-700">
                  ${groupData.accounts.map(acc => `
                    <div>
                      <div class="flex justify-between mb-1">
                        <span class="text-base font-medium">${acc.category}</span>
                        <span class="text-base font-medium">${acc.balance.toLocaleString()}å††</span>
                      </div>
                      ${acc.goal > 0 ? `
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                          <div class="bg-green-600 h-2.5 rounded-full" style="width: ${Math.min((acc.balance / acc.goal) * 100, 100)}%"></div>
                        </div>
                        <div class="text-xs text-right text-gray-500">ç›®æ¨™: ${acc.goal.toLocaleString()}å†† (${Math.round((acc.balance / acc.goal) * 100)}%)</div>
                      ` : ''}
                    </div>
                  `).join('')}
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function renderAllocation(dashboardData, templates) {
      const container = document.getElementById('content-allocation');
      container.innerHTML = `
        <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">äºˆç®—ã‚’æŒ¯ã‚Šåˆ†ã‘ã‚‹</h2>
            <div class="bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 text-lg font-bold px-4 py-2 rounded-lg">
              æŒ¯åˆ†å¯èƒ½: ${dashboardData.toBeBudgeted.toLocaleString()}å††
            </div>
          </div>
          <div class="mb-6 flex gap-4">
            <select id="template-select" class="flex-grow block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm">
              <option value="">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠ...</option>
              ${Object.keys(templates).map(name => `<option value="${name}">${name}</option>`).join('')}
            </select>
            <button id="load-template-btn" class="px-4 py-2 rounded-md text-white bg-gray-600 hover:bg-gray-700">èª­ã¿è¾¼ã¿</button>
          </div>
          <form id="allocation-form" class="space-y-4">
            <div class="border-b border-gray-200 dark:border-gray-700 pb-4 mb-4">
              <h3 class="text-lg font-bold mb-2">æœˆåï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ï¼‰</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                      <label for="income-wife" class="block text-sm font-medium">å¦»ã®çµ¦æ–™</label>
                      <input type="number" id="income-wife" name="income-å¦»ã®çµ¦æ–™" placeholder="0" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm">
                  </div>
                  <div>
                      <label for="income-husband" class="block text-sm font-medium">å¤«ã®çµ¦æ–™</label>
                      <input type="number" id="income-husband" name="income-å¤«ã®çµ¦æ–™" placeholder="0" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm">
                  </div>
              </div>
            </div>
            <div>
              <div class="flex justify-between items-center mb-2">
                <h3 class="text-lg font-bold">æœˆæ¬¡æŒ¯åˆ†</h3>
                <div class="text-sm text-gray-500">æ¶ˆè²»æ”¯å‡º</div>
              </div>
              <div id="allocation-inputs" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                ${dashboardData.accounts.map(acc => `
                  <div class="flex items-center gap-2">
                    <div class="flex-grow">
                      <label for="alloc-${acc.category}" class="block text-sm font-medium">${acc.category}</label>
                      <input type="number" id="alloc-${acc.category}" name="alloc-${acc.category}" placeholder="0" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm">
                    </div>
                    <input type="checkbox" id="isExpense-${acc.category}" name="isExpense-${acc.category}" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mt-6">
                  </div>
                `).join('')}
              </div>
            </div>
            <div id="savings-summary" class="mt-6 p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                <h4 class="font-bold text-lg">æ®‹ã‚Šã®è²¯é‡‘é¡ï¼ˆ2äººã®è²¯é‡‘ï¼‰: <span id="couples-savings" class="text-blue-600 dark:text-blue-400">0å††</span></h4>
            </div>
            <div class="pt-4 flex flex-col sm:flex-row gap-4">
              <button type="submit" class="flex-1 justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700">ã“ã®å†…å®¹ã§æŒ¯ã‚Šåˆ†ã‘ã‚‹</button>
              <button type="button" id="save-template-btn" class="flex-1 justify-center py-3 px-4 border border-gray-300 rounded-md shadow-sm text-lg font-medium bg-white dark:bg-gray-600 hover:bg-gray-50">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦ä¿å­˜</button>
            </div>
          </form>
        </div>
      `;
      setupAllocationListeners(templates);
    }
    
    function renderTransactionForm(accounts) {
      const container = document.getElementById('content-transaction');
      container.innerHTML = `
        <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg">
          <h2 id="transaction-form-title" class="text-2xl font-bold mb-6">å–å¼•ã‚’è¨˜éŒ²ã™ã‚‹</h2>
          <form id="transaction-form" class="space-y-6">
            <input type="hidden" id="transaction-id" name="id">
            <div>
              <label class="block text-sm font-medium">ç¨®é¡</label>
              <div class="mt-1 flex rounded-md">
                <button type="button" id="type-expense" class="px-4 py-2 bg-indigo-600 text-white rounded-l-md">æ”¯å‡º</button>
                <button type="button" id="type-income" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-r-md">åå…¥</button>
                <button type="button" id="type-allocation" class="px-4 py-2 bg-gray-200 dark:bg-gray-600">æŒ¯åˆ†</button>
              </div>
              <input type="hidden" id="transaction-type" name="type" value="æ”¯å‡º">
            </div>
            <div>
              <label for="date" class="block text-sm font-medium">æ—¥ä»˜</label>
              <input type="date" id="date" name="date" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm" required>
            </div>
            <div>
              <label for="amount" class="block text-sm font-medium">é‡‘é¡</label>
              <input type="number" id="amount" name="amount" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm" placeholder="ä¾‹: 3000" required>
            </div>
            <div id="category-wrapper">
              <label for="category" class="block text-sm font-medium">ã‚«ãƒ†ã‚´ãƒª (ã©ã®å£åº§ã‹ã‚‰ï¼Ÿ)</label>
              <select id="category" name="category" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm" required>
                ${accounts.map(acc => `<option value="${acc.category}">${acc.category}</option>`).join('')}
              </select>
            </div>
            <div>
              <label for="memo" class="block text-sm font-medium">ãƒ¡ãƒ¢</label>
              <input type="text" id="memo" name="memo" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm" placeholder="ä¾‹: ã‚¹ãƒ¼ãƒ‘ãƒ¼ã§ã®è²·ã„ç‰©">
            </div>
            <div class="pt-2 flex gap-4">
              <button type="submit" id="transaction-submit-btn" class="flex-grow justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">è¨˜éŒ²ã™ã‚‹</button>
              <button type="button" id="transaction-cancel-btn" class="hidden flex-grow justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium bg-white hover:bg-gray-50">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
          </form>
        </div>
      `;
      document.getElementById('date').valueAsDate = new Date();
      setupTransactionFormListeners(accounts);
    }

    function renderHistory(transactions) {
      const container = document.getElementById('content-history');
      const sortedTransactions = transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
      container.innerHTML = `
        <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg">
          <h2 class="text-2xl font-bold mb-6">å–å¼•å±¥æ­´</h2>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
              <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ—¥ä»˜</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç¨®é¡</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ã‚«ãƒ†ã‚´ãƒª</th>
                  <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">é‡‘é¡</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ãƒ¡ãƒ¢</th>
                  <th scope="col" class="relative px-6 py-3"><span class="sr-only">ç·¨é›†</span></th>
                </tr>
              </thead>
              <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                ${sortedTransactions.map(t => `
                  <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${new Date(t.date).toLocaleDateString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${t.type}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${t.category}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right ${t.type === 'åå…¥' ? 'text-green-600 dark:text-green-400' : (t.type === 'æ”¯å‡º' ? 'text-red-600 dark:text-red-400' : 'text-gray-500')}">${t.amount.toLocaleString()}å††</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${t.memo}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                      <button class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-900" onclick="editTransaction('${t.id}')">ç·¨é›†</button>
                      <button class="text-red-600 dark:text-red-400 hover:text-red-900 ml-4" onclick="deleteTransaction('${t.id}')">å‰Šé™¤</button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }
    
    function renderAccountSettings(accounts) {
      const container = document.getElementById('content-accounts');
      container.innerHTML = `
        <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">å£åº§è¨­å®š</h2>
            <button id="add-account-btn" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-md shadow-sm">
              <i class="fas fa-plus mr-2"></i>æ–°ã—ã„å£åº§ã‚’è¿½åŠ 
            </button>
          </div>
          <div id="account-list" class="space-y-4">
            ${accounts.map(acc => `
              <div class="p-4 border dark:border-gray-700 rounded-md">
                <form class="account-form" data-id="${acc.id}">
                  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div class="md:col-span-2">
                      <label class="block text-sm font-medium">å£åº§å</label>
                      <input type="text" name="category" value="${acc.category}" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm">
                    </div>
                    <div>
                      <label class="block text-sm font-medium">ç¨®é¡</label>
                      <select name="type" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm">
                        <option value="æ¶ˆè²»æ”¯å‡º" ${acc.type === 'æ¶ˆè²»æ”¯å‡º' ? 'selected' : ''}>æ¶ˆè²»æ”¯å‡º</option>
                        <option value="è²¯é‡‘ãƒ»ç©ç«‹" ${acc.type === 'è²¯é‡‘ãƒ»ç©ç«‹' ? 'selected' : ''}>è²¯é‡‘ãƒ»ç©ç«‹</option>
                      </select>
                    </div>
                    <div>
                      <label class="block text-sm font-medium">ã‚°ãƒ«ãƒ¼ãƒ—</label>
                      <input type="text" name="group" value="${acc.group || ''}" placeholder="ä¾‹: 2äººã®è²¯é‡‘" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm">
                    </div>
                    <div class="md:col-span-2">
                      <label class="block text-sm font-medium">ç›®æ¨™é‡‘é¡ (ä»»æ„)</label>
                      <input type="number" name="goal" value="${acc.goal || ''}" placeholder="0" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm">
                    </div>
                    <div class="flex items-center">
                      <input type="checkbox" name="isDefault" id="isDefault-${acc.id}" class="h-5 w-5 rounded border-gray-300 text-indigo-600" ${acc.isDefault ? 'checked' : ''}>
                      <label for="isDefault-${acc.id}" class="ml-2 text-sm">å¤«ã®çµ¦æ–™ã®å…¥é‡‘å…ˆã«ã™ã‚‹</label>
                    </div>
                    <div class="flex gap-2">
                      <button type="submit" class="flex-grow px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md shadow-sm">ä¿å­˜</button>
                      <button type="button" class="delete-account-btn flex-grow px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-md shadow-sm">å‰Šé™¤</button>
                    </div>
                  </div>
                </form>
              </div>
            `).join('')}
          </div>
        </div>
      `;
      setupAccountSettingsListeners();
    }
    
    function renderFutureExpenseForm(expenses, accounts) {
      const container = document.getElementById('content-future');
      container.innerHTML = `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold mb-6">å°†æ¥ã®å‡ºè²»ã‚’ç™»éŒ²</h2>
            <form id="future-expense-form" class="space-y-6">
              <input type="hidden" id="expense-id">
              <div>
                <label for="expense-name" class="block text-sm font-medium">å‡ºè²»å</label>
                <input type="text" id="expense-name" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700" placeholder="ä¾‹: è»Šã®è³¼å…¥" required>
              </div>
              <div>
                <label for="expense-amount" class="block text-sm font-medium">äºˆå®šé‡‘é¡</label>
                <input type="number" id="expense-amount" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700" placeholder="ä¾‹: 2000000" required>
              </div>
              <div>
                <label for="expense-date" class="block text-sm font-medium">äºˆå®šæ—¥</label>
                <input type="date" id="expense-date" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700" required>
              </div>
              <div>
                <label for="expense-source" class="block text-sm font-medium">å¼•ãè½ã¨ã—å£åº§</label>
                <select id="expense-source" name="sourceAccount" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm" required>
                  ${accounts.map(acc => `<option value="${acc.category}">${acc.category}</option>`).join('')}
                </select>
              </div>
              <div class="pt-2">
                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">ç™»éŒ²ãƒ»æ›´æ–°</button>
              </div>
            </form>
          </div>
          <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold mb-6">ç™»éŒ²æ¸ˆã¿ã®å‡ºè²»</h2>
            <div id="future-expense-list" class="space-y-4 max-h-96 overflow-y-auto">
              ${expenses && expenses.length > 0 ? expenses.map(e => `
                <div class="p-4 border dark:border-gray-700 rounded-md flex justify-between items-center">
                  <div>
                    <p class="font-semibold">${e.name}</p>
                    <p class="text-sm text-gray-500">${e.date} - ${Number(e.amount).toLocaleString()}å††</p>
                    <p class="text-xs text-gray-400">å¼•ãè½ã¨ã—å…ƒ: ${e.sourceAccount || 'æœªè¨­å®š'}</p>
                  </div>
                  <div>
                    <button class="text-blue-500 dark:text-blue-400 hover:text-blue-700 mr-4" onclick="editFutureExpense('${e.id}')"><i class="fas fa-edit"></i></button>
                    <button class="text-red-500 dark:text-red-400 hover:text-red-700" onclick="deleteFutureExpense('${e.id}')"><i class="fas fa-trash"></i></button>
                  </div>
                </div>
              `).join('') : '<p class="text-gray-500">ç™»éŒ²ã•ã‚ŒãŸå‡ºè²»ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>'}
            </div>
          </div>
        </div>
      `;
      setupFutureExpenseFormListeners();
    }
    
    function renderSimulation(templates, accounts) {
        const container = document.getElementById('content-simulation');
        container.innerHTML = `
            <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold mb-6">3å¹´é–“ã®è³‡ç”£ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h2>
                <div class="mb-4">
                  <label class="block text-sm font-medium">åŸºæº–ã«ã™ã‚‹æŒ¯åˆ†ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</label>
                  <select id="sim-template-select" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm">
                    ${Object.keys(templates).map(name => `<option value="${name}">${name}</option>`).join('')}
                  </select>
                </div>
                <div class="mb-6">
                  <label class="block text-sm font-medium">ã‚°ãƒ©ãƒ•ã«è¡¨ç¤ºã™ã‚‹å£åº§</label>
                  <div id="sim-accounts-selector" class="mt-2 grid grid-cols-2 md:grid-cols-4 gap-4">
                    ${accounts.map(acc => `
                      <div class="flex items-center">
                        <input id="sim-acc-${acc.category}" name="sim-accounts" value="${acc.category}" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <label for="sim-acc-${acc.category}" class="ml-2 block text-sm">${acc.category}</label>
                      </div>
                    `).join('')}
                  </div>
                </div>
                <button id="run-simulation-btn" class="w-full px-4 py-2 rounded-md text-white bg-indigo-600 hover:bg-indigo-700">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ</button>
                <canvas id="simulationChart" class="mt-6"></canvas>
            </div>
        `;
        setupSimulationListeners();
    }
    
    // =================================================================
    // ã‚°ãƒ©ãƒ•æç”»é–¢æ•°
    // =================================================================
    function drawSimulationChart(data) {
        const ctx = document.getElementById('simulationChart');
        if (!ctx) return;
        const context = ctx.getContext('2d');
        if (simulationChart) simulationChart.destroy();
        const textColor = document.documentElement.classList.contains('dark') ? '#fff' : '#333';
        const colorPalette = ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#3b82f6', '#8b5cf6', '#ec4899', '#6b7280'];

        const datasets = Object.entries(data.datasets).map(([label, values], index) => ({
          label: label,
          data: values,
          borderColor: colorPalette[index % colorPalette.length],
          backgroundColor: colorPalette[index % colorPalette.length] + '1A', // Add alpha for fill
          fill: label === '2äººã®è²¯é‡‘', // Only fill the main savings account
          tension: 0.1
        }));

        simulationChart = new Chart(context, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                scales: {
                    y: { ticks: { callback: value => (value / 10000).toLocaleString() + 'ä¸‡å††', color: textColor }, grid: { color: document.documentElement.classList.contains('dark') ? '#374151' : '#e5e7eb' } },
                    x: { ticks: { color: textColor }, grid: { color: document.documentElement.classList.contains('dark') ? '#374151' : '#e5e7eb' } }
                },
                plugins: { legend: { labels: { color: textColor } }, tooltip: { callbacks: { label: context => `${context.dataset.label}: ${context.parsed.y.toLocaleString()}å††` } } }
            }
        });
    }

    // =================================================================
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    // =================================================================
    function setupEventListeners() {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', e => {
          e.preventDefault();
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('border-indigo-500', 'text-indigo-600'));
          e.target.classList.add('border-indigo-500', 'text-indigo-600');
          document.querySelectorAll('.content-area').forEach(area => area.classList.add('hidden'));
          const tabName = e.target.id.split('-')[1];
          document.getElementById(`content-${tabName}`).classList.remove('hidden');
          if (tabName === 'simulation' && simulationChart) {
             setTimeout(() => simulationChart.resize(), 0);
          }
        });
      });
      document.getElementById('theme-toggle').addEventListener('click', () => {
        document.documentElement.classList.toggle('dark');
        document.getElementById('theme-icon-light').classList.toggle('hidden');
        document.getElementById('theme-icon-dark').classList.toggle('hidden');
        localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
      });
      if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark');
          document.getElementById('theme-icon-light').classList.add('hidden');
          document.getElementById('theme-icon-dark').classList.remove('hidden');
      }
      document.getElementById('register-salary-btn').addEventListener('click', showSalaryWizard);
    }

    function setupAllocationListeners(templates) {
        const form = document.getElementById('allocation-form');
        form.addEventListener('input', calculateCouplesSavings);

        form.addEventListener('submit', e => {
            e.preventDefault();
            showLoader();
            const formData = new FormData(e.target);
            const allocations = [];
            document.querySelectorAll('input[name^="alloc-"]').forEach(input => {
                const amount = Number(input.value) || 0;
                if (amount > 0) {
                    const category = input.name.replace('alloc-', '');
                    const isExpense = document.getElementById(`isExpense-${category}`).checked;
                    allocations.push({ category: category, amount: amount, isExpense: isExpense });
                }
            });
            google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).allocateFunds(allocations);
        });

        document.getElementById('load-template-btn').addEventListener('click', () => {
            const templateName = document.getElementById('template-select').value;
            if (templateName && templates[templateName]) {
                const template = templates[templateName];
                if(template.incomes) {
                  Object.entries(template.incomes).forEach(([category, amount]) => {
                      const input = document.getElementById(`income-${category === 'å¦»ã®çµ¦æ–™' ? 'wife' : 'husband'}`);
                      if (input) input.value = amount;
                  });
                }
                if(template.allocations) {
                  Object.entries(template.allocations).forEach(([category, data]) => {
                      const input = document.getElementById(`alloc-${category}`);
                      const checkbox = document.getElementById(`isExpense-${category}`);
                      if (input) input.value = data.amount;
                      if (checkbox) checkbox.checked = data.isExpense;
                  });
                }
            }
            calculateCouplesSavings();
        });

        document.getElementById('save-template-btn').addEventListener('click', () => {
            const templateName = prompt('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (templateName) {
                showLoader();
                const formData = new FormData(form);
                const templateData = { incomes: [], allocations: [] };
                for (let [key, value] of formData.entries()) {
                    const amount = Number(value) || 0;
                    if (key.startsWith('income-')) {
                        if(amount > 0) templateData.incomes.push({ category: key.replace('income-', ''), amount: amount });
                    } else if (key.startsWith('alloc-')) {
                        const category = key.replace('alloc-', '');
                        const isExpense = formData.has(`isExpense-${category}`);
                        if(amount > 0) templateData.allocations.push({ category: category, amount: amount, isExpense: isExpense });
                    }
                }
                google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).saveAllocationTemplate(templateName, templateData);
            }
        });
    }
    
    function calculateCouplesSavings() {
        const form = document.getElementById('allocation-form');
        const formData = new FormData(form);
        let totalIncome = 0;
        let totalAllocation = 0;
        for (let [key, value] of formData.entries()) {
            if (key.startsWith('income-')) {
                totalIncome += Number(value) || 0;
            } else if (key.startsWith('alloc-')) {
                totalAllocation += Number(value) || 0;
            }
        }
        const savings = totalIncome - totalAllocation;
        document.getElementById('couples-savings').textContent = `${savings.toLocaleString()}å††`;
    }
    
    function setupTransactionFormListeners(accounts) {
        const form = document.getElementById('transaction-form');
        form.addEventListener('submit', e => {
            e.preventDefault();
            showLoader();
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            if (data.id) {
                google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).updateTransaction(data);
            } else {
                google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).recordTransaction(data);
            }
        });
        
        document.getElementById('transaction-cancel-btn').addEventListener('click', resetTransactionForm);

        const typeExpenseBtn = document.getElementById('type-expense');
        const typeIncomeBtn = document.getElementById('type-income');
        const typeAllocationBtn = document.getElementById('type-allocation');
        const typeInput = document.getElementById('transaction-type');
        const categoryWrapper = document.getElementById('category-wrapper');
        const categorySelect = document.getElementById('category');
        
        const incomeCategories = `<option value="å¦»ã®çµ¦æ–™">å¦»ã®çµ¦æ–™</option><option value="å¤«ã®çµ¦æ–™">å¤«ã®çµ¦æ–™</option><option value="ãã®ä»–åå…¥">ãã®ä»–åå…¥</option>`;
        const accountCategories = accounts.map(c => `<option value="${c.category}">${c.category}</option>`).join('');

        function setType(type) {
            typeInput.value = type;
            [typeExpenseBtn, typeIncomeBtn, typeAllocationBtn].forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white');
                btn.classList.add('bg-gray-200', 'dark:bg-gray-600');
            });
            
            if(type === 'æ”¯å‡º') {
                typeExpenseBtn.classList.add('bg-indigo-600', 'text-white');
                categorySelect.innerHTML = accountCategories;
                categoryWrapper.querySelector('label').textContent = 'ã‚«ãƒ†ã‚´ãƒª (ã©ã®å£åº§ã‹ã‚‰ï¼Ÿ)';
            } else if (type === 'åå…¥') {
                typeIncomeBtn.classList.add('bg-indigo-600', 'text-white');
                categorySelect.innerHTML = incomeCategories;
                categoryWrapper.querySelector('label').textContent = 'åå…¥æº';
            } else if (type === 'æŒ¯åˆ†') {
                typeAllocationBtn.classList.add('bg-indigo-600', 'text-white');
                categorySelect.innerHTML = accountCategories;
                categoryWrapper.querySelector('label').textContent = 'ã‚«ãƒ†ã‚´ãƒª (ã©ã®å£åº§ã¸ï¼Ÿ)';
            }
        }
        
        typeExpenseBtn.addEventListener('click', () => setType('æ”¯å‡º'));
        typeIncomeBtn.addEventListener('click', () => setType('åå…¥'));
        typeAllocationBtn.addEventListener('click', () => setType('æŒ¯åˆ†'));
    }
    
    function setupAccountSettingsListeners() {
      document.querySelectorAll('.account-form').forEach(form => {
        form.addEventListener('submit', e => {
          e.preventDefault();
          showLoader();
          const formData = new FormData(e.target);
          const accountData = Object.fromEntries(formData.entries());
          accountData.id = e.target.dataset.id;
          accountData.isDefault = formData.has('isDefault');
          google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).saveAccount(accountData);
        });
      });
      document.querySelectorAll('.delete-account-btn').forEach(btn => {
        btn.addEventListener('click', e => {
          const form = e.target.closest('form');
          const id = form.dataset.id;
          if (confirm(`å£åº§ã€Œ${form.querySelector('input[name="category"]').value}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®å£åº§ã«é–¢é€£ã™ã‚‹å–å¼•å±¥æ­´ã¯å‰Šé™¤ã•ã‚Œã¾ã›ã‚“ã€‚`)) {
            showLoader();
            google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).deleteAccount(id);
          }
        });
      });
      document.getElementById('add-account-btn').addEventListener('click', () => {
        const newAccountData = { category: 'æ–°ã—ã„å£åº§', type: 'æ¶ˆè²»æ”¯å‡º', group: '', goal: 0, isDefault: false, id: '' };
        showLoader();
        google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).saveAccount(newAccountData);
      });
    }

    function setupFutureExpenseFormListeners() {
        document.getElementById('future-expense-form').addEventListener('submit', e => {
            e.preventDefault();
            showLoader();
            const data = {
                id: document.getElementById('expense-id').value,
                name: document.getElementById('expense-name').value,
                amount: document.getElementById('expense-amount').value,
                date: document.getElementById('expense-date').value,
                sourceAccount: document.getElementById('expense-source').value
            };
            google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).saveFutureExpense(data);
        });
    }

    function setupSimulationListeners() {
        document.getElementById('run-simulation-btn').addEventListener('click', () => {
            const templateName = document.getElementById('sim-template-select').value;
            if (!templateName) {
                showModal('ã‚¨ãƒ©ãƒ¼', 'ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®åŸºæº–ã«ã™ã‚‹æŒ¯åˆ†ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            const selectedAccounts = Array.from(document.querySelectorAll('input[name="sim-accounts"]:checked')).map(cb => cb.value);
            if (selectedAccounts.length === 0) {
              showModal('ã‚¨ãƒ©ãƒ¼', 'ã‚°ãƒ©ãƒ•ã«è¡¨ç¤ºã™ã‚‹å£åº§ã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„ã€‚');
              return;
            }
            showLoader();
            google.script.run.withSuccessHandler(onSimulationSuccess).withFailureHandler(onFailure).getSimulationData(templateName, selectedAccounts);
        });
    }
    
    // =================================================================
    // GASã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°
    // =================================================================
    function onSuccess(newData) {
        showModal('æˆåŠŸ', 'å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
        resetTransactionForm();
        initializeApp(newData);
    }
    
    function onSimulationSuccess(data) {
        hideLoader();
        drawSimulationChart(data);
    }
    
    function onFailure(error) {
      hideLoader();
      showModal('ã‚¨ãƒ©ãƒ¼', error.message);
      console.error(error);
    }
    
    // =================================================================
    // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    // =================================================================
    function showLoader() { loader.classList.remove('hidden'); }
    function hideLoader() { loader.classList.add('hidden'); }
    function showModal(title, content, element = null) {
      const container = document.getElementById('modal-container');
      container.innerHTML = `
        <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
          <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 lg:w-1/3 shadow-lg rounded-md bg-white dark:bg-gray-800">
            <div class="mt-3 text-center">
              <h3 class="text-lg leading-6 font-medium" id="modal-title">${title}</h3>
              <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500" id="modal-content">${content}</p>
              </div>
              <div id="modal-custom-content"></div>
              <div class="items-center px-4 py-3" id="modal-buttons">
                <button id="modal-close" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-600">é–‰ã˜ã‚‹</button>
              </div>
            </div>
          </div>
        </div>
      `;
      if (element) {
        document.getElementById('modal-custom-content').appendChild(element);
      }
      document.getElementById('modal-close').addEventListener('click', () => container.innerHTML = '');
    }

    function editTransaction(id) {
        const t = allData.transactions.find(tr => tr.id === id);
        if (!t) return;

        document.getElementById('tab-transaction').click();
        
        document.getElementById('transaction-form-title').textContent = 'å–å¼•ã‚’ç·¨é›†ã™ã‚‹';
        document.getElementById('transaction-id').value = t.id;
        document.getElementById('date').value = new Date(t.date).toISOString().split('T')[0];
        document.getElementById('amount').value = t.amount;
        document.getElementById('memo').value = t.memo;

        document.querySelector(`#type-${t.type === 'æ”¯å‡º' ? 'expense' : (t.type === 'åå…¥' ? 'income' : 'allocation')}`).click();
        
        const categorySelect = document.getElementById('category');
        categorySelect.value = t.category;

        document.getElementById('transaction-submit-btn').textContent = 'æ›´æ–°ã™ã‚‹';
        document.getElementById('transaction-cancel-btn').classList.remove('hidden');
    }

    function resetTransactionForm() {
        document.getElementById('transaction-form-title').textContent = 'å–å¼•ã‚’è¨˜éŒ²ã™ã‚‹';
        document.getElementById('transaction-form').reset();
        document.getElementById('date').valueAsDate = new Date();
        document.getElementById('transaction-submit-btn').textContent = 'è¨˜éŒ²ã™ã‚‹';
        document.getElementById('transaction-cancel-btn').classList.add('hidden');
        document.getElementById('type-expense').click();
    }

    function deleteTransaction(id) {
        if (confirm('ã“ã®å–å¼•ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
            showLoader();
            google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).deleteTransaction(id);
        }
    }

    function editFutureExpense(id) {
        const expense = allData.futureExpenses.find(e => e.id === id);
        if (expense) {
            document.getElementById('expense-id').value = expense.id;
            document.getElementById('expense-name').value = expense.name;
            document.getElementById('expense-amount').value = expense.amount;
            document.getElementById('expense-date').value = expense.date;
            document.getElementById('expense-source').value = expense.sourceAccount;
        }
    }
    function deleteFutureExpense(id) {
        if (confirm('ã“ã®å‡ºè²»ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
            showLoader();
            google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).deleteFutureExpense(id);
        }
    }

    function checkReminders() {
      const today = new Date();
      const day = today.getDate();
      const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
      const banner = document.getElementById('reminder-banner');
      let message = '';
      
      if (day >= 25 && day <= 27) {
        message = 'ğŸ’¡ å¦»ã®çµ¦æ–™æ—¥ã®æ™‚æœŸã§ã™ã€‚çµ¦æ–™ã®ç™»éŒ²ã‚’å¿˜ã‚Œãªã„ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚';
      } else if (day === endOfMonth || day === endOfMonth -1) {
        message = 'ğŸ’¡ å¤«ã®çµ¦æ–™æ—¥ã®æ™‚æœŸã§ã™ã€‚çµ¦æ–™ã®ç™»éŒ²ã‚’å¿˜ã‚Œãªã„ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚';
      }
      
      if (message) {
        banner.textContent = message;
        banner.classList.remove('hidden');
      }
    }

    function showSalaryWizard() {
      const wizardContent = document.createElement('div');
      wizardContent.className = 'space-y-4';
      wizardContent.innerHTML = `
        <div id="salary-step-1">
          <p class="text-lg mb-4">ã©ã¡ã‚‰ã®çµ¦æ–™ã§ã™ã‹ï¼Ÿ</p>
          <div class="flex gap-4">
            <button id="wife-salary-btn" class="flex-1 px-4 py-2 bg-pink-500 text-white rounded-md">å¦»ã®çµ¦æ–™</button>
            <button id="husband-salary-btn" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-md">å¤«ã®çµ¦æ–™</button>
          </div>
        </div>
        <div id="salary-step-2" class="hidden">
          <label for="salary-amount" class="block text-lg mb-2">çµ¦ä¸ã¯ã„ãã‚‰ã§ã™ã‹ï¼Ÿ</label>
          <input type="number" id="salary-amount" class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm" placeholder="é‡‘é¡ã‚’å…¥åŠ›">
          <input type="hidden" id="salary-type">
        </div>
      `;
      
      const modalButtons = document.createElement('div');
      modalButtons.className = 'flex gap-4 mt-4';
      modalButtons.innerHTML = `
        <button id="salary-back-btn" class="hidden flex-1 px-4 py-2 bg-gray-300 dark:bg-gray-600 rounded-md">æˆ»ã‚‹</button>
        <button id="salary-next-btn" class="hidden flex-1 px-4 py-2 bg-indigo-600 text-white rounded-md">ç™»éŒ²</button>
      `;
      
      showModal('çµ¦æ–™ã®ç™»éŒ²', '', wizardContent);
      document.getElementById('modal-buttons').innerHTML = '';
      document.getElementById('modal-buttons').appendChild(modalButtons);

      const step1 = wizardContent.querySelector('#salary-step-1');
      const step2 = wizardContent.querySelector('#salary-step-2');
      const backBtn = modalButtons.querySelector('#salary-back-btn');
      const nextBtn = modalButtons.querySelector('#salary-next-btn');
      const salaryTypeInput = wizardContent.querySelector('#salary-type');
      const salaryAmountInput = wizardContent.querySelector('#salary-amount');

      function goToStep2(type) {
        step1.classList.add('hidden');
        step2.classList.remove('hidden');
        backBtn.classList.remove('hidden');
        nextBtn.classList.remove('hidden');
        salaryTypeInput.value = type;
      }

      wizardContent.querySelector('#wife-salary-btn').addEventListener('click', () => goToStep2('å¦»ã®çµ¦æ–™'));
      wizardContent.querySelector('#husband-salary-btn').addEventListener('click', () => goToStep2('å¤«ã®çµ¦æ–™'));

      backBtn.addEventListener('click', () => {
        step1.classList.remove('hidden');
        step2.classList.add('hidden');
        backBtn.classList.add('hidden');
        nextBtn.classList.add('hidden');
      });

      nextBtn.addEventListener('click', () => {
        const salaryData = {
          date: new Date().toISOString().split('T')[0],
          type: 'åå…¥',
          amount: salaryAmountInput.value,
          category: salaryTypeInput.value,
          memo: `${salaryTypeInput.value} (ã‹ã‚“ãŸã‚“ç™»éŒ²)`
        };
        if (!salaryData.amount || salaryData.amount <= 0) {
          alert('é‡‘é¡ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          return;
        }
        showLoader();
        google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).recordSalary(salaryData);
        document.getElementById('modal-container').innerHTML = '';
      });
    }

  </script>
</body>
</html>
